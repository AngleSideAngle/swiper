# Swiper Stealing

This crate contains definitions for `RevocableCell` and `PreemptibleFuture` structs. `RevocableCell` is similar to `RefCell` in that it provides borrow checking guarantees at runtime, rather than compile time. However, unlike `RefCell`, ownership is checked whenever the future is polled, rather than when the data is accessed. This more coarse model is useful in contexts where long running tasks need exclusive ownership over a piece of hardware, and cannot wait for other tasks to yield ownership. What this translates to is newly scheduled `PreemptibleFuture` tasks preempt currently running `PreemptibleFuture` tasks with overlapping `RevocableCell` requirements when polled for the first time by stealing access to the requirement. Any preempted `PreemptibleFuture`, which just had its requirements stolen, will return a `Poll::Ready<Result<T, PreemptionError>::Err>` the next time its polled and not poll its inner future. When `PreemptibleFuture`s finish execution successfully, they revoke their ownership of all `RevocableCell` requirements.

This crate makes no heap allocations, and is async runtime agnostic. This means it can be used with various single threaded async runtimes, such as [smol](https://github.com/smol-rs/smol) and [embassy](https://github.com/embassy-rs/embassy). It is incompatible with multi threaded/work stealing async runtimes because the `RevocableCell` system is not thread safe. New `PreemptibleFutures` need to immediately have exclusive access to all `RevocableCell`s they depend on, which cannot be guaranteed in parallel execution unless polling the new future became a critical section.

It's currently not possible to provide a safe api to use swiper-stealing directly, as async functions must be wrapped with outer functions that wrap arguments of the form `x: T` with `x: RevocableCell<T>` and dereference the internal `UnsafeCell` to pass the internal value `x` into the original function. This requires the unstable feature [`async_fn_traits`](https://doc.rust-lang.org/beta/unstable-book/library-features/async-fn-traits.html?highlight=async#async_fn_traits) to call a generic async function with a return type. Instead, wrapping async functions is accomplished with macros in [swiper-derive](../swiper_derive).

